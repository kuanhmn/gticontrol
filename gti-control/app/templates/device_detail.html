{% extends "base.html" %}
{% block body %}
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
  <div>
    <div class="title" style="margin:0;">{{ device_id }}</div>
    <div class="muted">Server: {{ 'ON' if server_enabled else 'OFF' }} | Daily/Monthly từ server: {{ 'ON' if use_server_daily_monthly else 'OFF' }}</div>
  </div>
  <div>
    {% set online = state.get('online', False) %}
    <span class="badge {{ 'ok' if online else 'off' }}">{{ 'ONLINE' if online else 'OFFLINE' }}</span>
  </div>
</div>

<div class="tabs" style="margin:10px 0 16px;">
  <a href="/app/device/{{ device_id }}?tab=stats" class="{{ 'active' if tab=='stats' else '' }}">Thông số</a>
  <a href="/app/device/{{ device_id }}?tab=settings" class="{{ 'active' if tab=='settings' else '' }}">Cài đặt</a>
  <a href="/app/device/{{ device_id }}?tab=schedules" class="{{ 'active' if tab=='schedules' else '' }}">Lập lịch</a>
</div>

{% if tab == 'stats' %}
  <div class="row">
    <div class="col">
      <p class="title">GTI</p>
      <table>
        <tr><td>Công suất hoà lưới</td><td>{{ "%.2f"|format(state.get('power',0)) }} W</td></tr>
        <tr><td>Điện năng hoà lưới tổng</td><td>{{ "%.2f"|format(state.get('energy_total',0)) }} kWh</td></tr>
        <tr><td>Điện năng hoà lưới hôm nay</td><td>{{ "%.2f"|format(state.get('energy_daily',0)) }} kWh</td></tr>
        <tr><td>Điện năng hoà lưới tháng</td><td>{{ "%.2f"|format(state.get('energy_monthly',0)) }} kWh</td></tr>
        <tr><td>Điện áp DC</td><td>{{ "%.2f"|format(state.get('voltage_dc',0)) }} V</td></tr>
        <tr><td>Dòng DC</td><td>{{ "%.2f"|format(state.get('current',0)) }} A</td></tr>
        <tr><td>Nhiệt độ Mosfet</td><td>{{ "%.2f"|format(state.get('mosfet_temp',0)) }} °C</td></tr>
        <tr><td>Điện áp ngắt</td><td>{{ "%.2f"|format(state.get('cutoff_voltage',0)) }} V</td></tr>
        <tr><td>Công suất giới hạn</td><td>{{ "%.2f"|format(state.get('max_power_limit',0)) }} W</td></tr>
      </table>
    </div>

    <div class="col">
      <p class="title">Grid</p>
      <table>
        <tr><td>Điện áp lưới</td><td>{{ "%.2f"|format(state.get('grid_voltage',0)) }} V</td></tr>
        <tr><td>Tần số lưới</td><td>{{ "%.2f"|format(state.get('grid_frequency',0)) }} Hz</td></tr>
        <tr><td>Công suất lấy lưới</td><td>{{ "%.2f"|format(state.get('grid_power',0)) }} W</td></tr>
        <tr><td>Điện năng lấy lưới tổng</td><td>{{ "%.2f"|format(state.get('grid_energy_total',0)) }} kWh</td></tr>
        <tr><td>Điện năng lấy lưới hôm nay</td><td>{{ "%.2f"|format(state.get('grid_energy_daily',0)) }} kWh</td></tr>
        <tr><td>Điện năng lấy lưới tháng</td><td>{{ "%.2f"|format(state.get('grid_energy_monthly',0)) }} kWh</td></tr>
      </table>
    </div>

    <div class="col">
      <p class="title">Tieuthu</p>
      <table>
        <tr><td>Công suất tiêu thụ</td><td>{{ "%.2f"|format(state.get('tieuthu_power',0)) }} W</td></tr>
        <tr><td>Điện năng tiêu thụ tổng</td><td>{{ "%.2f"|format(state.get('tieuthu_energy_total',0)) }} kWh</td></tr>
        <tr><td>Điện năng tiêu thụ hôm nay</td><td>{{ "%.2f"|format(state.get('tieuthu_energy_daily',0)) }} kWh</td></tr>
        <tr><td>Điện năng tiêu thụ tháng</td><td>{{ "%.2f"|format(state.get('tieuthu_energy_monthly',0)) }} kWh</td></tr>
      </table>
    </div>
  </div>
{% elif tab == 'settings' %}
  <p class="title">Cài đặt</p>
  <form method="post" action="/app/device/{{ device_id }}/set">
    <input type="hidden" name="action" value="cutoff">
    <div class="grid2">
      <div>
        <div class="muted">Điện áp ngắt (V)</div>
        <input class="input" name="cutoff_voltage" type="number" step="0.1" value="{{ "%.2f"|format(state.get('cutoff_voltage',0)) }}">
      </div>
      <div style="align-self:end; text-align:right;">
        <button class="btn" type="submit">Áp dụng</button>
      </div>
    </div>
  </form>

  <form method="post" action="/app/device/{{ device_id }}/set" style="margin-top:14px;">
    <input type="hidden" name="action" value="maxpower">
    <div class="grid2">
      <div>
        <div class="muted">Công suất giới hạn (W)</div>
        <input class="input" name="max_power_limit" type="number" step="10" value="{{ "%.2f"|format(state.get('max_power_limit',0)) }}">
      </div>
      <div style="align-self:end; text-align:right;">
        <button class="btn" type="submit">Áp dụng</button>
      </div>
    </div>
  </form>
{% elif tab == 'schedules' %}
  <p class="title">Lập lịch</p>
  {% for i in [1,2,3] %}
  <form method="post" action="/app/device/{{ device_id }}/set" class="card" style="margin-bottom:10px;">
    <input type="hidden" name="action" value="sched{{ i }}">
    <div class="grid3">
      <div>
        <div class="muted">Bắt đầu</div>
        <input class="input" name="schedule{{ i }}_start" type="time" value="{{ schedules.get('schedule'+i|string,{}).get('start','00:00') if schedules }}">
      </div>
      <div>
        <div class="muted">Kết thúc</div>
        <input class="input" name="schedule{{ i }}_end" type="time" value="{{ schedules.get('schedule'+i|string,{}).get('end','00:00') if schedules }}">
      </div>
      <div>
        <div class="muted">Điện áp ngắt (V)</div>
        <input class="input" name="schedule{{ i }}_cutoff_voltage" type="number" step="0.1" value="{{ "%.2f"|format(state.get('schedule'+i|string+'_cutoff_voltage',0)) }}">
      </div>
      <div>
        <div class="muted">Công suất (W)</div>
        <input class="input" name="schedule{{ i }}_max_power" type="number" step="10" value="{{ "%.2f"|format(state.get('schedule'+i|string+'_max_power',0)) }}">
      </div>
      <div style="align-self:end; text-align:right;">
        <button class="btn" type="submit">Lưu lịch {{ i }}</button>
      </div>
    </div>
  </form>
  {% endfor %}
{% endif %}
{% endblock %}
